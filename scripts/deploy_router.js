const { ethers } = require("ethers");
require("dotenv").config();

async function main() {
    const PRIVATE_KEY = process.env.PRIVATE_KEY;
    const RPC_URL = process.argv[2]; // Pass RPC URL as first argument

    if (!PRIVATE_KEY || !RPC_URL) {
        console.error("Usage: node scripts/deploy_router.js <RPC_URL>");
        process.exit(1);
    }

    const provider = new ethers.JsonRpcProvider(RPC_URL);
    const wallet = new ethers.Wallet(PRIVATE_KEY, provider);

    const PERMIT2_ADDRESS = "0x000000000022D473030F116dDEE9F6B43aC78BA3";
    const FEE_RECIPIENT = wallet.address; // Fee goes back to the deployer wallet

    console.log(`ðŸš€ Deploying TokenGiftRouter on ${RPC_URL}...`);
    console.log(`Wallet: ${wallet.address}`);

    const abi = [
        "constructor(address _permit2, address _feeRecipient)",
        "function batchGift(tuple(tuple(address token, uint256 amount)[] permitted, uint256 nonce, uint256 deadline) permit, tuple(address to, uint256 requestedAmount)[] transfers, address owner, bytes signature) external payable"
    ];

    // Read bytecode from a build file (manually provide here for portability)
    const bytecode = "608060405234801561001057600080fd5b506040516104bc3803806104bc8339818101604052810190610032919061007d565b806000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550816001806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050506100f9565b6000806040838503121561008f57600080fd5b825173ffffffffffffffffffffffffffffffffffffffff1681526020019050919050565b600082198211156100cf576100ce6100da565b5b500190565b60006100e5826100b4565b9050919050565b6100f4816100db565b82525050565b600060208201905061010e60008301846100eb565b92915050565b805173ffffffffffffffffffffffffffffffffffffffff1690602001805173ffffffffffffffffffffffffffffffffffffffff169060200150919050565b828051918201111561015357600080fd5b4261015c82610065565b9050919050565b61016c81610129565b815461017982610196565b81601f0160209004602002602001604051908101604052809291908101915b808211156101be578154815260200190600101906101a1565b50505090509392505050565b60006101d282610129565b9050919050565b60006101e4826101c5565b9050919050565b6101f4816101db565b82525050565b600060208201905061020e60008301846101eb565b92915050565b600081519050919050565b828051918201111561023257600080fd5b4261023b82610214565b9050919050565b61024b81610222565b82525050565b60006020820190506102666000830184610240565b92915050565b60006020820190506102816000830184610240565b92915050565b80519060200190919050565b600082601f8301126102ad57600080fd5b81516102bd8482610293565b9392505050565b60006102cd82610222565b9050919050565b60006102df826102c0565b9050919050565b6102ef816102d6565b82525050565b600060208201905061030960008301846102e6565b92915050565b600082601f83011261032557600080fd5b81516103358482610293565b9392505050565b600081519050919050565b600061035082610328565b9050919050565b600061036282610343565b9050919050565b61037281610359565b82525050565b600060208201905061038c6000830184610369565b92915050565b60006020820190506103a76000830184610369565b92915050565b600080600080608085870312156103cd57600080fd5b845167ffffffffffffffff8111156103e357600080fd5b6040519080825260200260200160405250905060005b8181111561042c5760208385038260200201810151610410888201610156565b84826020020152506001016103f5565b50845167ffffffffffffffff81111561044357600080fd5b6040519080825260200260200160405250905060005b8181111561048c5760208385038260200201810151610470888201610225565b8482602002015250600101610455565b5060408501516104a385604001610214565b945060608501516104b585606001610214565b93509695505050505050565b610738806100f96000396000f3fe";

    const factory = new ethers.ContractFactory(abi, bytecode, wallet);
    const contract = await factory.deploy(PERMIT2_ADDRESS, FEE_RECIPIENT);
    await contract.waitForDeployment();

    console.log(`âœ… TokenGiftRouter deployed to: ${await contract.getAddress()}`);
    console.log(`\nAdd this to your .env of the worker:`);
    console.log(`ROUTER_ADDRESS_${await contract.getAddress()}`);
}

main().catch((error) => {
    console.error(error);
    process.exit(1);
});
